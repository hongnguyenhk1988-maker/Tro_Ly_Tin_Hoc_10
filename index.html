<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý Tin học AI 10 Hiện Đại</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            width: 100%;
            max-width: 768px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        .user-bubble {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.3rem;
        }
        .ai-bubble {
            background-color: #e5e7eb; /* Gray 200 */
            color: #1f2937; /* Gray 800 */
            align-self: flex-start;
            border-bottom-left-radius: 0.3rem;
            white-space: pre-wrap; /* Preserve formatting for code/explanation */
        }
    </style>
</head>
<body>

    <div class="chat-container">
        <!-- Header -->
        <div class="p-4 bg-gray-900 text-white shadow-md">
            <h1 class="text-xl font-bold">Gia Sư AI Tin Học 10 Hiện Đại</h1>
            <p class="text-sm text-gray-400">Tập trung hỗ trợ Python, AI, và Đạo đức số. KHÔNG giải bài tập hộ.</p>
        </div>

        <!-- Chat Display Area -->
        <div id="chat-output" class="flex-1 p-6 space-y-4 overflow-y-auto">
            <div class="flex">
                <div class="message-bubble ai-bubble">
                    Chào em! Tôi là Gia sư AI chuyên Tin học Lớp 10 Hiện đại. Tôi có thể giúp em gỡ lỗi code Python, giải thích các khái niệm về AI/Data/Đạo đức số. Hãy hỏi tôi nhé!
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200 flex space-x-3">
            <input type="text" id="chat-input" placeholder="Nhập câu hỏi hoặc đoạn code Python của em..."
                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                   onkeydown="if(event.key === 'Enter') sendMessage()">
            <button id="send-btn" onclick="sendMessage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 flex items-center justify-center disabled:opacity-50">
                <span id="btn-text">Gửi</span>
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>
    </div>

    <script>
        const chatOutput = document.getElementById('chat-output');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const btnText = document.getElementById('btn-text');

        // *** CẤU HÌNH API VÀ SYSTEM INSTRUCTION QUAN TRỌNG NHẤT ***
        // LƯU Ý QUAN TRỌNG: Bạn PHẢI điền Khóa API (API Key) hợp lệ vào đây khi chạy trên máy tính cá nhân.
        // Nếu đang chạy file HTML trên máy tính (giao thức file:///), vui lòng thay thế chuỗi "YOUR_API_KEY_HERE" bằng API Key của bạn.
        const apiKey = "YOUR_API_KEY_HERE"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // 1. LỆNH HỆ THỐNG (SYSTEM INSTRUCTION) - ĐỊNH HÌNH VAI TRÒ CHATBOT
        // Lệnh này được thiết kế dựa trên logic của bot Poe "GVTINHOC10HIENDAI"
        const systemPrompt = `Bạn là Gia sư AI chuyên môn Tin học Lớp 10 (chương trình hiện đại) tại Việt Nam.
                              Chủ đề trọng tâm bạn cần tập trung hỗ trợ bao gồm: Lập trình Python cơ bản (cấu trúc điều khiển, mảng/list), Tin học và Ứng dụng (AI, IoT, Big Data), Hệ cơ số, và Đạo đức số.
                              Nhiệm vụ của bạn là hỗ trợ học sinh học tập một cách chủ động và phát triển kỹ năng tự học.
                              QUY TẮC CẦN TUÂN THỦ NGHIÊM NGẶT:
                              1. Không bao giờ giải hoàn chỉnh bài tập hoặc cung cấp đoạn code hoàn chỉnh cho học sinh.
                              2. Đối với câu hỏi về code Python: Chỉ ra lỗi cú pháp hoặc logic (nếu có) và đưa ra gợi ý/giải thích về cách sửa lỗi đó, KHÔNG đưa ra giải pháp code đã hoàn thiện.
                              3. Đối với câu hỏi lý thuyết: Giải thích các khái niệm bằng ngôn ngữ đơn giản, có ví dụ minh họa thực tế, đặc biệt nhấn mạnh vào bối cảnh công nghệ hiện đại.
                              4. Giọng điệu phải thân thiện, kiên nhẫn và khuyến khích học sinh tự tìm tòi, khám phá.`;

        let chatHistory = [];

        // Hỗ trợ hiển thị tin nhắn
        function appendMessage(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex ' + (sender === 'user' ? 'justify-end' : 'justify-start');

            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble ' + (sender === 'user' ? 'user-bubble' : 'ai-bubble');
            messageBubble.innerHTML = text; // Use innerHTML to handle potential Markdown formatting

            messageWrapper.appendChild(messageBubble);
            chatOutput.appendChild(messageWrapper);
            chatOutput.scrollTop = chatOutput.scrollHeight; // Auto scroll to latest message
        }

        // Bật/tắt trạng thái tải
        function setLodingState(isLoading) {
            sendBtn.disabled = isLoading;
            loadingSpinner.classList.toggle('hidden', !isLoading);
            btnText.textContent = isLoading ? 'Đang xử lý...' : 'Gửi';
        }

        // Logic gửi tin nhắn
        async function sendMessage() {
            const userQuery = chatInput.value.trim();
            if (userQuery === "") return;

            // KIỂM TRA API KEY TRƯỚC KHI GỬI
            // Lỗi đã được khắc phục: Điều kiện if đã kiểm tra đúng chuỗi placeholder.
            if (apiKey === "AIzaSyBaYb9HB9xXNAcQNPAeEU3LqMaLyF3kAUI" || apiKey === "") {
                appendMessage('ai', '⚠️ LỖI KẾT NỐI AI: Bạn cần điền Khóa API (API Key) hợp lệ vào biến **apiKey** trong mã JavaScript để chức năng AI hoạt động. Hãy kiểm tra lại file HTML của bạn!');
                chatInput.value = '';
                return;
            }

            // 1. Hiển thị tin nhắn người dùng
            appendMessage('user', userQuery);
            chatInput.value = '';
            setLodingState(true);

            // 2. Thêm vào lịch sử chat
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            // 3. Gọi API với tính năng Retry (Exponential Backoff)
            try {
                const aiResponse = await retryFetch(userQuery, 3);
                
                // 4. Hiển thị và cập nhật lịch sử chat
                appendMessage('ai', aiResponse);
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
            } catch (error) {
                console.error("Lỗi khi gọi API:", error);
                appendMessage('ai', 'Xin lỗi, tôi đang gặp lỗi kết nối API. Vui lòng kiểm tra lại kết nối mạng hoặc xem Console (F12).');
            } finally {
                setLodingState(false);
            }
        }
        
        // Hàm gọi API với Exponential Backoff
        async function retryFetch(userQuery, maxRetries) {
            const payload = {
                contents: chatHistory, 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Không có phản hồi.";
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Handle Rate Limit (429) with exponential backoff
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    } else {
                        throw error; // Max retries reached
                    }
                }
            }
        }
    </script>
</body>
</html>